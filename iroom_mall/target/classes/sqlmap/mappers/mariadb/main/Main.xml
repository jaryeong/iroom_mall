<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="main">

	<select id="selectMainMenuList"  parameterType="mainPVO"  resultType="mainMenuDVO">
		SELECT /* /main/Main.xml - selectMainMenu(메인화면 메뉴 목록 조회) */
              A.MENU_LEVEL
				, A.MENU_ID
				, A.UPPER_MENU_ID
				, A.MENU_NM
				, A.MENU_URL
                , CASE WHEN A.MENU_LEVEL = '2' AND A.MENU_URL IS NULL THEN 'TAB'
                       ELSE A.POPUP_TY_CODE
                  END AS "MENU_MODE"
	            , (SELECT B.ORDR
	                 FROM TB_SYS_MENU_M B
	                WHERE B.MENU_LEVEL = 1
	                  AND B.MENU_ID = CONCAT(SUBSTR(A.MENU_ID,1,2),'000000')) AS "ROOT_ORDR"
	            , CASE WHEN A.MENU_LEVEL > 1 THEN CONCAT(SUBSTR(A.MENU_ID,1,2),'000000') ELSE NULL END AS "ROOT_MENU_ID"
          FROM TB_SYS_MENU_M A
		 WHERE A.MENU_ID IN (SELECT DISTINCT C.MENU_ID
		                       FROM TB_SYS_USER_M B
		                          , TB_SYS_MENU_AUTH_D C
		                          , TB_SYS_MENU_M D
		                      WHERE B.USER_ID = #{userId}
		                        AND   ( (C.AUTHOR_SE_CODE = 'U' AND B.USER_ID = C.AUTHOR_ID ) OR
			                             (C.AUTHOR_SE_CODE = 'G' AND B.GRAD_CODE = C.AUTHOR_ID) )
			                    AND   C.MENU_ID = D.MENU_ID
			                    AND   D.USE_YN = 'Y'
			                    AND   D.MENU_LEVEL > 1
			                  UNION ALL
			                  SELECT DISTINCT G.UPPER_MENU_ID
		                       FROM TB_SYS_USER_M E
		                          , TB_SYS_MENU_AUTH_D F
		                          , TB_SYS_MENU_M G
		                      WHERE E.USER_ID = #{userId}
		                        AND   ( (F.AUTHOR_SE_CODE = 'U' AND E.USER_ID = F.AUTHOR_ID ) OR
			                             (F.AUTHOR_SE_CODE = 'G' AND E.GRAD_CODE = F.AUTHOR_ID) )
			                    AND   F.MENU_ID = G.MENU_ID
			                    AND   G.USE_YN = 'Y'
		                     )
		 ORDER BY ROOT_ORDR, A.MENU_LEVEL, A.ORDR, A.MENU_ID
	</select>

	<select id="selectMyMenuList"  parameterType="mainPVO"  resultType="myMenuDVO">
		SELECT /* /main/Main.xml - selectMyMenu(메인화면 My메뉴 목록 조회) */
                 A.GROUP_ID
                 , A.GROUP_NM
                 , A.BASS_SCRIN_YN
                 , A.MENU_ORDR
                 , A.MENU_ID
                 , B.MENU_NM
                 , B.MENU_URL
                 , '01' AS "VIEW_MODE"
                 , B.USE_YN
          FROM TB_ENV_MYMENU_H A
          LEFT OUTER JOIN (SELECT C.MENU_ID
                                , C.MENU_NM
                                , C.MENU_URL
                                , C.USE_YN
                             FROM TB_SYS_MENU_M C
                            WHERE C.USE_YN = 'Y'
                           ) B
            ON A.MENU_ID = B.MENU_ID
		 WHERE A.USER_ID = #{userId}
         ORDER BY A.BASS_SCRIN_YN DESC, A.GROUP_ID ASC, A.MENU_ORDR ASC, A.MENU_ID
	</select>
	
	<select id="selectBookmarkFolderList"  parameterType="myBookmarkPVO"  resultType="myBookmarkDVO">
		SELECT /* /main/Main.xml - selectBookmarkFolderList(북마크 폴더 조회) */
		       A.FOLDER_ID
		     , A.USER_ID
		     , A.BASS_FOLDER_YN
		     , A.FOLDER_NM
		     , A.SORT_ORDR
		  FROM TB_KMS_KNWLDG_BKMK_FOLDER_M A
		 WHERE A.USER_ID = #{userId}
		 ORDER BY BASS_FOLDER_YN DESC, SORT_ORDR, FOLDER_NM ASC
	</select>
	
	<select id="selectBookmarkList"  parameterType="myBookmarkPVO"  resultType="myBookmarkDVO">
		SELECT /* /main/Main.xml - selectBookmarkFolderList(내폴더 목록 조회) */
			   X.*
		  FROM (
			-- 북마크 지식 목록
			SELECT B.FOLDER_ID
			     , B.KNWLDG_ALL_SEQ
			     , B.KNWLDG_SE_CODE
			     , CONCAT('[지식] ', A.KNWLDG_SJ) AS TITLE
			     , B.SORT_ORDR
			FROM TB_KMS_KNWLDG_M A
					LEFT OUTER JOIN TB_KMS_KNWLDG_BKMK_D B ON A.KNWLDG_SEQ = B.KNWLDG_ALL_SEQ AND B.KNWLDG_SE_CODE IN ('MNL', 'CASE')
						LEFT OUTER JOIN TB_KMS_KNWLDG_BKMK_FOLDER_M C ON B.FOLDER_ID = C.FOLDER_ID
			WHERE C.USER_ID = #{userId}
			
			UNION
			
			-- 북마크 컨텐츠 목록
			SELECT B.FOLDER_ID
			     , B.KNWLDG_ALL_SEQ
			     , B.KNWLDG_SE_CODE
			     , CONCAT('[컨텐츠] ', A.CNTNTS_SJ) AS TITLE
			     , B.SORT_ORDR
			FROM TB_KMS_CNTNTS_M A
					LEFT OUTER JOIN TB_KMS_KNWLDG_BKMK_D B ON A.CNTNTS_SEQ = B.KNWLDG_ALL_SEQ AND B.KNWLDG_SE_CODE IN ('FAQ', 'SCRIPT')
						LEFT OUTER JOIN TB_KMS_KNWLDG_BKMK_FOLDER_M C ON B.FOLDER_ID = C.FOLDER_ID
			WHERE C.USER_ID = #{userId}
			
			UNION
			
			-- 북마크 용어 목록
			SELECT B.FOLDER_ID
			     , B.KNWLDG_ALL_SEQ
			     , B.KNWLDG_SE_CODE
			     , CONCAT('[용어] ', A.WORD) AS TITLE
			     , B.SORT_ORDR
			FROM TB_KMS_WORD_M A
					LEFT OUTER JOIN TB_KMS_KNWLDG_BKMK_D B ON A.WORD_SEQ = B.KNWLDG_ALL_SEQ AND B.KNWLDG_SE_CODE IN ('WORD')
						LEFT OUTER JOIN TB_KMS_KNWLDG_BKMK_FOLDER_M C ON B.FOLDER_ID = C.FOLDER_ID
			WHERE C.USER_ID = #{userId}
			
			UNION
			
			-- 북마크 상품 목록
			SELECT B.FOLDER_ID
			     , B.KNWLDG_ALL_SEQ
			     , B.KNWLDG_SE_CODE
			     , CONCAT('[상품] ', A.GOODS_NM) AS TITLE
			     , B.SORT_ORDR
			FROM TB_KMS_GOODS_M A
					LEFT OUTER JOIN TB_KMS_KNWLDG_BKMK_D B ON A.GOODS_SEQ = B.KNWLDG_ALL_SEQ AND B.KNWLDG_SE_CODE IN ('GOODS')
						LEFT OUTER JOIN TB_KMS_KNWLDG_BKMK_FOLDER_M C ON B.FOLDER_ID = C.FOLDER_ID
			WHERE C.USER_ID = #{userId}
		) X	
	</select>

	<insert id="insertmyMenu"  parameterType="java.util.List">
        INSERT /* /main/Main.xml - "insertmyMenu"(My메뉴그룹 등록) */
          INTO TB_ENV_MYMENU_H
             ( USER_ID
			 , GROUP_ID
			 , MENU_ID
			 , MENU_ORDR
			 , GROUP_NM
			 , BASS_SCRIN_YN
			 , REGIST_USER_ID
			 , REGIST_DT)
        VALUES
        <foreach collection="list" item="item" index="index" separator=",">
             ( #{item.userId}
			 , #{item.groupId}
			 , #{item.menuId}
			 , #{item.menuOrdr}
			 , #{item.groupNm}
			 , #{item.bassScrinYn}
			 , #{item.registUserId}
			 , DATE_FORMAT(now(), '%Y%m%d%H%i%s'))
		</foreach>
	</insert>

	<delete id="deleteMyMenuAll" parameterType="myMenuDVO">
		DELETE /* /main/Main.xml - "deleteMyMenuAll"(My메뉴그룹 삭제) */
		  FROM TB_ENV_MYMENU_H
		 WHERE GROUP_ID = #{groupId}
    </delete>
    
    <update id="updateVcatnDaycnt" parameterType="schVcatnSanctnDVO">
		UPDATE /* /schedule/SchVcatnSanctn.xml - updateVcatnDaycnt(휴가 사용일수 업데이트)  */
			   TB_SCH_VCATN_M A
			 , (SELECT USER_ID, VCATN_DAYCNT
				  FROM TB_SCH_VCATN_SANCTN_M
			     WHERE VCATN_SEQ = #{vcatnSeq}) B
		   
		   SET A.USE_VCATN_DAYCNT = IFNULL(A.USE_VCATN_DAYCNT,0) + B.VCATN_DAYCNT 
			 , A.REMNDR_VCATN_DAYCNT = A.REMNDR_VCATN_DAYCNT - B.VCATN_DAYCNT
			 , A.UPDT_DT = DATE_FORMAT(now(), '%Y%m%d%H%i%s')
			 , A.UPDT_USER_ID = #{loginUserId}
		 WHERE A.STDYY = DATE_FORMAT(now(), '%Y')
		   AND A.USER_ID = B.USER_ID
	</update>
</mapper>
